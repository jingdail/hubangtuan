(function(global,factory){typeof exports==='object'&&typeof module!=='undefined'?module.exports=factory():typeof define==='function'&&define.amd?define(factory):(global.WeCropper=factory())}(this,(function(){'use strict';var device=void 0;var TOUCH_STATE=['touchstarted','touchmoved','touchended'];function firstLetterUpper(str){return str.charAt(0).toUpperCase()+str.slice(1)}function setTouchState(instance){var arg=[],len=arguments.length-1;while(len-->0)arg[len]=arguments[len+1];TOUCH_STATE.forEach(function(key,i){if(arg[i]!==undefined){instance[key]=arg[i]}})}function validator(instance,o){Object.defineProperties(instance,o)}function getDevice(){if(!device){device=uni.getSystemInfoSync()}return device}var tmp={};var ref=getDevice();var pixelRatio=ref.pixelRatio;var DEFAULT={id:{default:'cropper',get:function get(){return tmp.id},set:function set(value){if(typeof(value)!=='string'){console.error(("id："+value+" is invalid"))}tmp.id=value}},width:{default:750,get:function get(){return tmp.width},set:function set(value){if(typeof(value)!=='number'){console.error(("width："+value+" is invalid"))}tmp.width=value}},height:{default:750,get:function get(){return tmp.height},set:function set(value){if(typeof(value)!=='number'){console.error(("height："+value+" is invalid"))}tmp.height=value}},pixelRatio:{default:pixelRatio,get:function get(){return tmp.pixelRatio},set:function set(value){if(typeof(value)!=='number'){console.error(("pixelRatio："+value+" is invalid"))}tmp.pixelRatio=value}},scale:{default:2.5,get:function get(){return tmp.scale},set:function set(value){if(typeof(value)!=='number'){console.error(("scale："+value+" is invalid"))}tmp.scale=value}},zoom:{default:5,get:function get(){return tmp.zoom},set:function set(value){if(typeof(value)!=='number'){console.error(("zoom："+value+" is invalid"))}else if(value<0||value>10){console.error("zoom should be ranged in 0 ~ 10")}tmp.zoom=value}},src:{default:'',get:function get(){return tmp.src},set:function set(value){if(typeof(value)!=='string'){console.error(("src："+value+" is invalid"))}tmp.src=value}},cut:{default:{},get:function get(){return tmp.cut},set:function set(value){if(typeof(value)!=='object'){console.error(("cut："+value+" is invalid"))}tmp.cut=value}},boundStyle:{default:{},get:function get(){return tmp.boundStyle},set:function set(value){if(typeof(value)!=='object'){console.error(("boundStyle："+value+" is invalid"))}tmp.boundStyle=value}},onReady:{default:null,get:function get(){return tmp.ready},set:function set(value){tmp.ready=value}},onBeforeImageLoad:{default:null,get:function get(){return tmp.beforeImageLoad},set:function set(value){tmp.beforeImageLoad=value}},onImageLoad:{default:null,get:function get(){return tmp.imageLoad},set:function set(value){tmp.imageLoad=value}},onBeforeDraw:{default:null,get:function get(){return tmp.beforeDraw},set:function set(value){tmp.beforeDraw=value}}};var ref$1=getDevice();var windowWidth=ref$1.windowWidth;function prepare(){var self=this;self.attachPage=function(){var pages=getCurrentPages();var pageContext=pages[pages.length-1];Object.defineProperty(pageContext,'wecropper',{get:function get(){console.warn('Instance will not be automatically bound to the page after v1.4.0\n\n'+'Please use a custom instance name instead\n\n'+'Example: \n'+'this.mycropper = new WeCropper(options)\n\n'+'// ...\n'+'this.mycropper.getCropperImage()');return self}})};self.createCtx=function(){var id=self.id;var targetId=self.targetId;if(id){self.ctx=self.ctx||uni.createCanvasContext(id);self.targetCtx=self.targetCtx||uni.createCanvasContext(targetId)}else{console.error("constructor: create canvas context failed, 'id' must be valuable")}};self.deviceRadio=windowWidth/750}var commonjsGlobal=typeof window!=='undefined'?window:typeof global!=='undefined'?global:typeof self!=='undefined'?self:{};function createCommonjsModule(fn,module){return module={exports:{}},fn(module,module.exports),module.exports}var tools=createCommonjsModule(function(module,exports){exports.isStr=function(v){return typeof v==='string'};exports.isNum=function(v){return typeof v==='number'};exports.isArr=Array.isArray;exports.isUndef=function(v){return v===undefined};exports.isTrue=function(v){return v===true};exports.isFalse=function(v){return v===false};exports.isFunc=function(v){return typeof v==='function'};exports.isObj=exports.isObject=function(obj){return obj!==null&&typeof obj==='object'};var _toString=Object.prototype.toString;exports.isPlainObject=function(obj){return _toString.call(obj)==='[object Object]'};var hasOwnProperty=Object.prototype.hasOwnProperty;exports.hasOwn=function(obj,key){return hasOwnProperty.call(obj,key)};exports.noop=function(a,b,c){};exports.isValidArrayIndex=function(val){var n=parseFloat(String(val));return n>=0&&Math.floor(n)===n&&isFinite(val)}});var tools_7=tools.isFunc;var tools_10=tools.isPlainObject;var EVENT_TYPE=['ready','beforeImageLoad','beforeDraw','imageLoad'];function observer(){var self=this;self.on=function(event,fn){if(EVENT_TYPE.indexOf(event)>-1){if(tools_7(fn)){event==='ready'?fn(self):self[("on"+(firstLetterUpper(event)))]=fn}}else{console.error(("event: "+event+" is invalid"))}return self}}function wxPromise(fn){return function(obj){var args=[],len=arguments.length-1;while(len-->0)args[len]=arguments[len+1];if(obj===void 0)obj={};return new Promise(function(resolve,reject){obj.success=function(res){resolve(res)};obj.fail=function(err){reject(err)};fn.apply(void 0,[obj].concat(args))})}}function draw(ctx,reserve){if(reserve===void 0)reserve=false;return new Promise(function(resolve){ctx.draw(reserve,resolve)})}var getImageInfo=wxPromise(uni.getImageInfo);var canvasToTempFilePath=wxPromise(uni.canvasToTempFilePath);var base64=createCommonjsModule(function(module,exports){(function(root){var freeExports='object'=='object'&&exports;var freeModule='object'=='object'&&module&&module.exports==freeExports&&module;var freeGlobal=typeof commonjsGlobal=='object'&&commonjsGlobal;if(freeGlobal.global===freeGlobal||freeGlobal.window===freeGlobal){root=freeGlobal}var InvalidCharacterError=function(message){this.message=message};InvalidCharacterError.prototype=new Error;InvalidCharacterError.prototype.name='InvalidCharacterError';var error=function(message){throw new InvalidCharacterError(message);};var TABLE='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';var REGEX_SPACE_CHARACTERS=/[\t\n\f\r ]/g;var decode=function(input){input=String(input).replace(REGEX_SPACE_CHARACTERS,'');var length=input.length;if(length%4==0){input=input.replace(/==?$/,'');length=input.length}if(length%4==1||/[^+a-zA-Z0-9/]/.test(input)){error('Invalid character: the string to be decoded is not correctly encoded.')}var bitCounter=0;var bitStorage;var buffer;var output='';var position=-1;while(++position<length){buffer=TABLE.indexOf(input.charAt(position));bitStorage=bitCounter%4?bitStorage*64+buffer:buffer;if(bitCounter++%4){output+=String.fromCharCode(0xFF&bitStorage>>(-2*bitCounter&6))}}return output};var encode=function(input){input=String(input);if(/[^\0-\xFF]/.test(input)){error('The string to be encoded contains characters outside of the '+'Latin1 range.')}var padding=input.length%3;var output='';var position=-1;var a;var b;var c;var buffer;var length=input.length-padding;while(++position<length){a=input.charCodeAt(position)<<16;b=input.charCodeAt(++position)<<8;c=input.charCodeAt(++position);buffer=a+b+c;output+=(TABLE.charAt(buffer>>18&0x3F)+TABLE.charAt(buffer>>12&0x3F)+TABLE.charAt(buffer>>6&0x3F)+TABLE.charAt(buffer&0x3F))}if(padding==2){a=input.charCodeAt(position)<<8;b=input.charCodeAt(++position);buffer=a+b;output+=(TABLE.charAt(buffer>>10)+TABLE.charAt((buffer>>4)&0x3F)+TABLE.charAt((buffer<<2)&0x3F)+'=')}else if(padding==1){buffer=input.charCodeAt(position);output+=(TABLE.charAt(buffer>>2)+TABLE.charAt((buffer<<4)&0x3F)+'==')}return output};var base64={'encode':encode,'decode':decode,'version':'0.1.0'};if(typeof undefined=='function'&&typeof undefined.amd=='object'&&undefined.amd){undefined(function(){return base64})}else if(freeExports&&!freeExports.nodeType){if(freeModule){freeModule.exports=base64}else{for(var key in base64){base64.hasOwnProperty(key)&&(freeExports[key]=base64[key])}}}else{root.base64=base64}}(commonjsGlobal))});function makeURI(strData,type){return'data:'+type+';base64,'+strData}function fixType(type){type=type.toLowerCase().replace(/jpg/i,'jpeg');var r=type.match(/png|jpeg|bmp|gif/)[0];return'image/'+r}function encodeData(data){var str='';if(typeof data==='string'){str=data}else{for(var i=0;i<data.length;i++){str+=String.fromCharCode(data[i])}}return base64.encode(str)}function getImageData(canvasId,x,y,width,height,done){uni.canvasGetImageData({canvasId:canvasId,x:x,y:y,width:width,height:height,success:function success(res){done(res,null)},fail:function fail(res){done(null,res)}})}function genBitmapImage(oData){var biWidth=oData.width;var biHeight=oData.height;var biSizeImage=biWidth*biHeight*3;var bfSize=biSizeImage+54;var BITMAPFILEHEADER=[0x42,0x4D,bfSize&0xff,bfSize>>8&0xff,bfSize>>16&0xff,bfSize>>24&0xff,0,0,0,0,54,0,0,0];var BITMAPINFOHEADER=[40,0,0,0,biWidth&0xff,biWidth>>8&0xff,biWidth>>16&0xff,biWidth>>24&0xff,biHeight&0xff,biHeight>>8&0xff,biHeight>>16&0xff,biHeight>>24&0xff,1,0,24,0,0,0,0,0,biSizeImage&0xff,biSizeImage>>8&0xff,biSizeImage>>16&0xff,biSizeImage>>24&0xff,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];var iPadding=(4-((biWidth*3)%4))%4;var aImgData=oData.data;var strPixelData='';var biWidth4=biWidth<<2;var y=biHeight;var fromCharCode=String.fromCharCode;do{var iOffsetY=biWidth4*(y-1);var strPixelRow='';for(var x=0;x<biWidth;x++){var iOffsetX=x<<2;strPixelRow+=fromCharCode(aImgData[iOffsetY+iOffsetX+2])+fromCharCode(aImgData[iOffsetY+iOffsetX+1])+fromCharCode(aImgData[iOffsetY+iOffsetX])}for(var c=0;c<iPadding;c++){strPixelRow+=String.fromCharCode(0)}strPixelData+=strPixelRow}while(--y)var strEncoded=encodeData(BITMAPFILEHEADER.concat(BITMAPINFOHEADER))+encodeData(strPixelData);return strEncoded}function convertToImage(canvasId,x,y,width,height,type,done){if(done===void 0)done=function(){};if(type===undefined){type='png'}type=fixType(type);if(/bmp/.test(type)){getImageData(canvasId,x,y,width,height,function(data,err){var strData=genBitmapImage(data);tools_7(done)&&done(makeURI(strData,'image/'+type),err)})}else{console.error('暂不支持生成\''+type+'\'类型的base64图片')}}var CanvasToBase64={convertToImage:convertToImage,convertToBMP:function(ref,done){if(ref===void 0)ref={};var canvasId=ref.canvasId;var x=ref.x;var y=ref.y;var width=ref.width;var height=ref.height;if(done===void 0)done=function(){};return convertToImage(canvasId,x,y,width,height,'bmp',done)}};function methods(){var self=this;var boundWidth=self.width;var boundHeight=self.height;var id=self.id;var targetId=self.targetId;var pixelRatio=self.pixelRatio;var ref=self.cut;var x=ref.x;if(x===void 0)x=0;var y=ref.y;if(y===void 0)y=0;var width=ref.width;if(width===void 0)width=boundWidth;var height=ref.height;if(height===void 0)height=boundHeight;self.updateCanvas=function(done){if(self.croperTarget){self.ctx.drawImage(self.croperTarget,self.imgLeft,self.imgTop,self.scaleWidth,self.scaleHeight)}tools_7(self.onBeforeDraw)&&self.onBeforeDraw(self.ctx,self);self.setBoundStyle(self.boundStyle);self.ctx.draw(false,done);return self};self.pushOrign=function(src){self.src=src;tools_7(self.onBeforeImageLoad)&&self.onBeforeImageLoad(self.ctx,self);return getImageInfo({src:src}).then(function(res){var innerAspectRadio=res.width/res.height;var customAspectRadio=width/height;self.croperTarget=res.path;if(innerAspectRadio<customAspectRadio){self.rectX=x;self.baseWidth=width;self.baseHeight=width/innerAspectRadio;self.rectY=y-Math.abs((height-self.baseHeight)/2)}else{self.rectY=y;self.baseWidth=height*innerAspectRadio;self.baseHeight=height;self.rectX=x-Math.abs((width-self.baseWidth)/2)}self.imgLeft=self.rectX;self.imgTop=self.rectY;self.scaleWidth=self.baseWidth;self.scaleHeight=self.baseHeight;self.update();return new Promise(function(resolve){self.updateCanvas(resolve)})}).then(function(){tools_7(self.onImageLoad)&&self.onImageLoad(self.ctx,self)})};self.getCropperBase64=function(done){if(done===void 0)done=function(){};CanvasToBase64.convertToBMP({canvasId:id,x:x,y:y,width:width,height:height},done)};self.getCropperImage=function(opt,fn){var customOptions=opt;var canvasOptions={canvasId:id,x:x,y:y,width:width,height:height};var task=function(){return Promise.resolve()};if(tools_10(customOptions)&&customOptions.original){task=function(){self.targetCtx.drawImage(self.croperTarget,self.imgLeft*pixelRatio,self.imgTop*pixelRatio,self.scaleWidth*pixelRatio,self.scaleHeight*pixelRatio);canvasOptions={canvasId:targetId,x:x*pixelRatio,y:y*pixelRatio,width:width*pixelRatio,height:height*pixelRatio};return draw(self.targetCtx)}}return task().then(function(){if(tools_10(customOptions)){canvasOptions=Object.assign({},canvasOptions,customOptions)}if(tools_7(customOptions)){fn=customOptions}var arg=canvasOptions.componentContext?[canvasOptions,canvasOptions.componentContext]:[canvasOptions];return canvasToTempFilePath.apply(null,arg)}).then(function(res){var tempFilePath=res.tempFilePath;return tools_7(fn)?fn.call(self,tempFilePath,null):tempFilePath}).catch(function(err){if(tools_7(fn)){fn.call(self,null,err)}else{throw err}})}}var getNewScale=function(oldScale,oldDistance,zoom,touch0,touch1){var xMove,yMove,newDistance;xMove=Math.round(touch1.x-touch0.x);yMove=Math.round(touch1.y-touch0.y);newDistance=Math.round(Math.sqrt(xMove*xMove+yMove*yMove));return oldScale+0.001*zoom*(newDistance-oldDistance)};function update(){var self=this;if(!self.src){return}self.__oneTouchStart=function(touch){self.touchX0=Math.round(touch.x);self.touchY0=Math.round(touch.y)};self.__oneTouchMove=function(touch){var xMove,yMove;if(self.touchended){return self.updateCanvas()}xMove=Math.round(touch.x-self.touchX0);yMove=Math.round(touch.y-self.touchY0);var imgLeft=Math.round(self.rectX+xMove);var imgTop=Math.round(self.rectY+yMove);self.outsideBound(imgLeft,imgTop);self.updateCanvas()};self.__twoTouchStart=function(touch0,touch1){var xMove,yMove,oldDistance;self.touchX1=Math.round(self.rectX+self.scaleWidth/2);self.touchY1=Math.round(self.rectY+self.scaleHeight/2);xMove=Math.round(touch1.x-touch0.x);yMove=Math.round(touch1.y-touch0.y);oldDistance=Math.round(Math.sqrt(xMove*xMove+yMove*yMove));self.oldDistance=oldDistance};self.__twoTouchMove=function(touch0,touch1){var oldScale=self.oldScale;var oldDistance=self.oldDistance;var scale=self.scale;var zoom=self.zoom;self.newScale=getNewScale(oldScale,oldDistance,zoom,touch0,touch1);self.newScale<=1&&(self.newScale=1);self.newScale>=scale&&(self.newScale=scale);self.scaleWidth=Math.round(self.newScale*self.baseWidth);self.scaleHeight=Math.round(self.newScale*self.baseHeight);var imgLeft=Math.round(self.touchX1-self.scaleWidth/2);var imgTop=Math.round(self.touchY1-self.scaleHeight/2);self.outsideBound(imgLeft,imgTop);self.updateCanvas()};self.__xtouchEnd=function(){self.oldScale=self.newScale;self.rectX=self.imgLeft;self.rectY=self.imgTop}}var handle={touchStart:function touchStart(e){var self=this;var ref=e.touches;var touch0=ref[0];var touch1=ref[1];if(!self.src){return}setTouchState(self,true,null,null);self.__oneTouchStart(touch0);if(e.touches.length>=2){self.__twoTouchStart(touch0,touch1)}},touchMove:function touchMove(e){var self=this;var ref=e.touches;var touch0=ref[0];var touch1=ref[1];if(!self.src){return}setTouchState(self,null,true);if(e.touches.length===1){self.__oneTouchMove(touch0)}if(e.touches.length>=2){self.__twoTouchMove(touch0,touch1)}},touchEnd:function touchEnd(e){var self=this;if(!self.src){return}setTouchState(self,false,false,true);self.__xtouchEnd()}};function cut(){var self=this;var boundWidth=self.width;var boundHeight=self.height;var ref=self.cut;var x=ref.x;if(x===void 0)x=0;var y=ref.y;if(y===void 0)y=0;var width=ref.width;if(width===void 0)width=boundWidth;var height=ref.height;if(height===void 0)height=boundHeight;self.outsideBound=function(imgLeft,imgTop){self.imgLeft=imgLeft>=x?x:self.scaleWidth+imgLeft-x<=width?x+width-self.scaleWidth:imgLeft;self.imgTop=imgTop>=y?y:self.scaleHeight+imgTop-y<=height?y+height-self.scaleHeight:imgTop};self.setBoundStyle=function(ref){if(ref===void 0)ref={};var color=ref.color;if(color===void 0)color='#04b00f';var mask=ref.mask;if(mask===void 0)mask='rgba(0, 0, 0, 0.3)';var lineWidth=ref.lineWidth;if(lineWidth===void 0)lineWidth=1;var boundOption=[{start:{x:x-lineWidth,y:y+10-lineWidth},step1:{x:x-lineWidth,y:y-lineWidth},step2:{x:x+10-lineWidth,y:y-lineWidth}},{start:{x:x-lineWidth,y:y+height-10+lineWidth},step1:{x:x-lineWidth,y:y+height+lineWidth},step2:{x:x+10-lineWidth,y:y+height+lineWidth}},{start:{x:x+width-10+lineWidth,y:y-lineWidth},step1:{x:x+width+lineWidth,y:y-lineWidth},step2:{x:x+width+lineWidth,y:y+10-lineWidth}},{start:{x:x+width+lineWidth,y:y+height-10+lineWidth},step1:{x:x+width+lineWidth,y:y+height+lineWidth},step2:{x:x+width-10+lineWidth,y:y+height+lineWidth}}];self.ctx.beginPath();self.ctx.setFillStyle(mask);self.ctx.fillRect(0,0,x,boundHeight);self.ctx.fillRect(x,0,width,y);self.ctx.fillRect(x,y+height,width,boundHeight-y-height);self.ctx.fillRect(x+width,0,boundWidth-x-width,boundHeight);self.ctx.fill();boundOption.forEach(function(op){self.ctx.beginPath();self.ctx.setStrokeStyle(color);self.ctx.setLineWidth(lineWidth);self.ctx.moveTo(op.start.x,op.start.y);self.ctx.lineTo(op.step1.x,op.step1.y);self.ctx.lineTo(op.step2.x,op.step2.y);self.ctx.stroke()})}}var version="1.3.7";var WeCropper=function WeCropper(params){var self=this;var _default={};validator(self,DEFAULT);Object.keys(DEFAULT).forEach(function(key){_default[key]=DEFAULT[key].default});Object.assign(self,_default,params);self.prepare();self.attachPage();self.createCtx();self.observer();self.cutt();self.methods();self.init();self.update();return self};WeCropper.prototype.init=function init(){var self=this;var src=self.src;self.version=version;typeof self.onReady==='function'&&self.onReady(self.ctx,self);if(src){self.pushOrign(src)}else{self.updateCanvas()}setTouchState(self,false,false,false);self.oldScale=1;self.newScale=1;return self};Object.assign(WeCropper.prototype,handle);WeCropper.prototype.prepare=prepare;WeCropper.prototype.observer=observer;WeCropper.prototype.methods=methods;WeCropper.prototype.cutt=cut;WeCropper.prototype.update=update;return WeCropper})));